# Phonebook åº”ç”¨æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å¯¹ Phonebook åº”ç”¨å®æ–½çš„å…¨é¢æ€§èƒ½ä¼˜åŒ–æªæ–½ï¼ŒåŒ…æ‹¬æ•°æ®åº“ä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥ã€JVMè°ƒä¼˜ã€å®¹å™¨åŒ–ä¼˜åŒ–ç­‰å¤šä¸ªæ–¹é¢ã€‚

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æªæ–½

### 1. æ•°æ®åº“å±‚é¢ä¼˜åŒ–

#### 1.1 ç´¢å¼•ä¼˜åŒ–
- **ä¸»è¦ç´¢å¼•**ï¼š
  - `idx_phone_number`: ç”µè¯å·ç å”¯ä¸€ç´¢å¼•
  - `idx_email`: é‚®ç®±ç´¢å¼•
  - `idx_name`: å§“åç´¢å¼•
  - `idx_category`: åˆ†ç±»ç´¢å¼•
  - `idx_created_at`: åˆ›å»ºæ—¶é—´ç´¢å¼•

- **å¤åˆç´¢å¼•**ï¼š
  - `idx_name_phone`: å§“å+ç”µè¯å¤åˆç´¢å¼•
  - `idx_category_name`: åˆ†ç±»+å§“åå¤åˆç´¢å¼•

- **å…¨æ–‡æœç´¢ç´¢å¼•**ï¼š
  - å¯¹ `name` å’Œ `email` å­—æ®µåˆ›å»ºå…¨æ–‡ç´¢å¼•ï¼Œæå‡æœç´¢æ€§èƒ½

#### 1.2 è¿æ¥æ± ä¼˜åŒ– (HikariCP)
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20      # æœ€å¤§è¿æ¥æ•°
      minimum-idle: 5            # æœ€å°ç©ºé—²è¿æ¥
      connection-timeout: 30000  # è¿æ¥è¶…æ—¶
      idle-timeout: 600000       # ç©ºé—²è¶…æ—¶
      max-lifetime: 1800000      # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
      leak-detection-threshold: 60000  # è¿æ¥æ³„æ¼æ£€æµ‹
```

#### 1.3 JPA/Hibernate ä¼˜åŒ–
- **æ‰¹é‡æ“ä½œ**ï¼šå¯ç”¨æ‰¹é‡æ’å…¥å’Œæ›´æ–°
- **äºŒçº§ç¼“å­˜**ï¼šå¯ç”¨ Hibernate äºŒçº§ç¼“å­˜
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨ `@QueryHints` ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- **æ‡’åŠ è½½**ï¼šåˆç†ä½¿ç”¨æ‡’åŠ è½½ç­–ç•¥

### 2. ç¼“å­˜ç­–ç•¥

#### 2.1 Redis ç¼“å­˜é…ç½®
- **è”ç³»äººåˆ—è¡¨ç¼“å­˜**ï¼š5åˆ†é’Ÿ TTL
- **è”ç³»äººè¯¦æƒ…ç¼“å­˜**ï¼š15åˆ†é’Ÿ TTL
- **æœç´¢ç»“æœç¼“å­˜**ï¼š3åˆ†é’Ÿ TTL
- **åˆ†ç±»ç»Ÿè®¡ç¼“å­˜**ï¼š30åˆ†é’Ÿ TTL

#### 2.2 ç¼“å­˜æ³¨è§£ä½¿ç”¨
```java
@Cacheable(value = "contacts", key = "#pageable.pageNumber + '_' + #pageable.pageSize")
@CacheEvict(value = {"contacts", "searchResults"}, allEntries = true)
@CachePut(value = "contact", key = "#contactDTO.id")
```

### 3. JVM æ€§èƒ½è°ƒä¼˜

#### 3.1 å†…å­˜é…ç½®
```bash
JAVA_OPTS="-server \
    -Xmx1g \
    -Xms512m \
    -XX:NewRatio=2"
```

#### 3.2 åƒåœ¾æ”¶é›†å™¨ä¼˜åŒ–
```bash
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:+UseStringDeduplication
```

#### 3.3 å…¶ä»–JVMä¼˜åŒ–
```bash
-XX:+OptimizeStringConcat \
-XX:+UseCompressedOops \
-XX:+UseCompressedClassPointers \
-Djava.security.egd=file:/dev/./urandom
```

### 4. åº”ç”¨å±‚é¢ä¼˜åŒ–

#### 4.1 å¼‚æ­¥å¤„ç†
- é…ç½®è‡ªå®šä¹‰çº¿ç¨‹æ± å¤„ç†å¼‚æ­¥ä»»åŠ¡
- ä½¿ç”¨ `@Async` æ³¨è§£å¤„ç†è€—æ—¶æ“ä½œ
- æ‰¹é‡å¤„ç†å’Œç¼“å­˜é¢„çƒ­

#### 4.2 æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ `EXISTS` æ›¿ä»£ `COUNT > 0`
- ä¼˜åŒ–æœç´¢æŸ¥è¯¢ï¼ŒæŒ‰ç›¸å…³æ€§æ’åº
- åˆ†é¡µæŸ¥è¯¢é¿å…æ·±åº¦åˆ†é¡µé—®é¢˜

#### 4.3 æ•°æ®è½¬æ¢ä¼˜åŒ–
- ä½¿ç”¨ `BeanUtils.copyProperties()` å¿«é€Ÿå±æ€§å¤åˆ¶
- å‡å°‘ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º
- ä¼˜åŒ– DTO è½¬æ¢é€»è¾‘

### 5. å®¹å™¨åŒ–ä¼˜åŒ–

#### 5.1 Docker é•œåƒä¼˜åŒ–
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒå¤§å°
- ä½¿ç”¨ `openjdk:8-jre-slim` åŸºç¡€é•œåƒ
- é root ç”¨æˆ·è¿è¡Œåº”ç”¨

#### 5.2 å®¹å™¨è¿è¡Œæ—¶ä¼˜åŒ–
```dockerfile
# ä½¿ç”¨ dumb-init ä½œä¸º PID 1 è¿›ç¨‹
ENTRYPOINT ["dumb-init", "--"]

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3
```

### 6. Kubernetes ä¼˜åŒ–

#### 6.1 èµ„æºé…ç½®
```yaml
resources:
  requests:
    memory: "768Mi"
    cpu: "500m"
  limits:
    memory: "1.5Gi"
    cpu: "1000m"
```

#### 6.2 æ°´å¹³æ‰©å±•é…ç½®
- HPA åŸºäº CPU å’Œå†…å­˜ä½¿ç”¨ç‡è‡ªåŠ¨æ‰©ç¼©å®¹
- æœ€å°å‰¯æœ¬æ•°ï¼š3
- æœ€å¤§å‰¯æœ¬æ•°ï¼š10

#### 6.3 Redis é›†æˆ
- éƒ¨ç½² Redis ä½œä¸ºç¼“å­˜æœåŠ¡
- é…ç½®é€‚å½“çš„å†…å­˜é™åˆ¶å’Œ LRU ç­–ç•¥

### 7. ç›‘æ§å’ŒæŒ‡æ ‡

#### 7.1 åº”ç”¨æŒ‡æ ‡
- JVM å†…å­˜ä½¿ç”¨æƒ…å†µ
- åƒåœ¾æ”¶é›†ç»Ÿè®¡
- çº¿ç¨‹æ± çŠ¶æ€
- æ•°æ®åº“è¿æ¥æ± ç›‘æ§

#### 7.2 ä¸šåŠ¡æŒ‡æ ‡
- è”ç³»äººåˆ›å»º/æ›´æ–°/åˆ é™¤è®¡æ•°
- æœç´¢è¯·æ±‚è®¡æ•°
- å“åº”æ—¶é—´åˆ†å¸ƒ

#### 7.3 Prometheus é›†æˆ
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•å·¥å…·
- Apache Bench (ab)
- curl å“åº”æ—¶é—´æµ‹è¯•
- è‡ªå®šä¹‰æ€§èƒ½æµ‹è¯•è„šæœ¬

### è¿è¡Œæ€§èƒ½æµ‹è¯•
```bash
chmod +x performance-test.sh
./performance-test.sh
```

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡
- **å“åº”æ—¶é—´**ï¼šå¹³å‡ < 100ms
- **ååé‡**ï¼š> 1000 requests/second
- **å¹¶å‘ç”¨æˆ·**ï¼šæ”¯æŒ 100+ å¹¶å‘ç”¨æˆ·
- **å†…å­˜ä½¿ç”¨**ï¼š< 1GB å †å†…å­˜

## ğŸ”§ é…ç½®æ–‡ä»¶è¯´æ˜

### application.yml å…³é”®é…ç½®
```yaml
# æ•°æ®åº“è¿æ¥æ± 
spring.datasource.hikari.*

# JPA ä¼˜åŒ–
spring.jpa.properties.hibernate.*

# Redis ç¼“å­˜
spring.redis.*
spring.cache.*

# ç›‘æ§
management.endpoints.*
```

### Dockerfile ä¼˜åŒ–è¦ç‚¹
- å¤šé˜¶æ®µæ„å»º
- JVM å‚æ•°ä¼˜åŒ–
- å¥åº·æ£€æŸ¥é…ç½®
- å®‰å…¨æ€§é…ç½®

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### å…³é”®ç›‘æ§æŒ‡æ ‡
1. **åº”ç”¨æ€§èƒ½**
   - å“åº”æ—¶é—´
   - ååé‡
   - é”™è¯¯ç‡

2. **ç³»ç»Ÿèµ„æº**
   - CPU ä½¿ç”¨ç‡
   - å†…å­˜ä½¿ç”¨ç‡
   - ç£ç›˜ I/O

3. **æ•°æ®åº“æ€§èƒ½**
   - è¿æ¥æ± çŠ¶æ€
   - æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
   - æ…¢æŸ¥è¯¢æ—¥å¿—

4. **ç¼“å­˜æ€§èƒ½**
   - ç¼“å­˜å‘½ä¸­ç‡
   - ç¼“å­˜å¤§å°
   - è¿‡æœŸç­–ç•¥æ•ˆæœ

### ç›‘æ§å·¥å…·é›†æˆ
- Prometheus + Grafana
- Spring Boot Actuator
- Micrometer æŒ‡æ ‡æ”¶é›†

## ğŸš¨ æ€§èƒ½è°ƒä¼˜å»ºè®®

### 1. å®šæœŸç›‘æ§
- è®¾ç½®æ€§èƒ½åŸºçº¿
- ç›‘æ§å…³é”®æŒ‡æ ‡è¶‹åŠ¿
- åŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ

### 2. å®¹é‡è§„åˆ’
- æ ¹æ®ä¸šåŠ¡å¢é•¿é¢„æµ‹èµ„æºéœ€æ±‚
- åˆç†è®¾ç½® HPA é˜ˆå€¼
- å®šæœŸè¯„ä¼°æ•°æ®åº“æ€§èƒ½

### 3. ç¼“å­˜ç­–ç•¥
- æ ¹æ®æ•°æ®è®¿é—®æ¨¡å¼è°ƒæ•´ TTL
- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- é¿å…ç¼“å­˜é›ªå´©å’Œç©¿é€

### 4. æ•°æ®åº“ä¼˜åŒ–
- å®šæœŸåˆ†ææ…¢æŸ¥è¯¢
- ä¼˜åŒ–ç´¢å¼•ç­–ç•¥
- è€ƒè™‘è¯»å†™åˆ†ç¦»

## ğŸ“ æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“ç´¢å¼•å·²åˆ›å»ºå¹¶ä¼˜åŒ–
- [ ] è¿æ¥æ± é…ç½®åˆç†
- [ ] Redis ç¼“å­˜æ­£å¸¸å·¥ä½œ
- [ ] JVM å‚æ•°å·²è°ƒä¼˜
- [ ] å®¹å™¨èµ„æºé…ç½®é€‚å½“
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸æ”¶é›†
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æŒ‡å—](./k8s-README.md)
- [Kubernetes é…ç½®](./KUBERNETES-DEPLOYMENT.md)
- [åº”ç”¨é…ç½®](./README.md)

---

**æ³¨æ„**ï¼šæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µå’Œç›‘æ§æ•°æ®ä¸æ–­è°ƒæ•´å’Œä¼˜åŒ–ã€‚